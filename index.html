const channelID = "3062393";
const apiKey = "E514Y3YSM2ZC9J36";
const fieldNum = 1;
const resultsNum = 100;
const marqueeSpan = document.getElementById("marqueeText");
const marqueeWidth = document.querySelector('.marquee').offsetWidth;
let posX = marqueeWidth;

function isToday(dateStr) {
  const date = new Date(dateStr);
  const today = new Date();
  return date.getFullYear() === today.getFullYear() &&
         date.getMonth() === today.getMonth() &&
         date.getDate() === today.getDate();
}

async function fetchData() {
  try {
    const url = `https://api.thingspeak.com/channels/${channelID}/fields/${fieldNum}.json?api_key=${apiKey}&results=${resultsNum}`;
    const response = await fetch(url);
    const data = await response.json();
    const feeds = data.feeds;

    if (!feeds || feeds.length === 0) {
      marqueeSpan.textContent = "目前沒有資料";
      return;
    }

    const todayFeeds = feeds.filter(feed => feed.created_at && isToday(feed.created_at));
    if (todayFeeds.length === 0) {
      marqueeSpan.textContent = "今天沒有資料";
      return;
    }

    const lastFeeds = todayFeeds.slice(-6);
    const messages = lastFeeds.map(feed => feed[`field${fieldNum}`] || "沒有資料");
    marqueeSpan.textContent = messages.join(" ｜ ");
    posX = marqueeWidth;
  } catch (error) {
    marqueeSpan.textContent = "讀取失敗";
    console.error(error);
  }
}

function animateMarquee() {
  posX -= 2;
  if (posX < -marqueeSpan.offsetWidth) {
    posX = marqueeWidth;
  }
  marqueeSpan.style.transform = `translateX(${posX}px)`;
  requestAnimationFrame(animateMarquee);
}

fetchData();
setInterval(fetchData, 60000);
animateMarquee();
